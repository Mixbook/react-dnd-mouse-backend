!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ReactDnDMouseMoveBackend=t():e.ReactDnDMouseMoveBackend=t()}(this,function(){return function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t,o){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var r=o(1),i=n(r),s=function(e){return new i.default(e)};t.default=s},function(e,t){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e){return{x:e.clientX,y:e.clientY}}function r(e){var t=e.nodeType===s?e:e.parentElement;if(!t)return null;var o=t.getBoundingClientRect(),n=o.top,r=o.left;return{x:r,y:n}}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),s=1,u=function(){function e(t){o(this,e),this.actions=t.getActions(),this.monitor=t.getMonitor(),this.registry=t.getRegistry(),this.sourceNodes={},this.sourceNodesOptions={},this.sourcePreviewNodes={},this.sourcePreviewNodesOptions={},this.targetNodes={},this.targetNodeOptions={},this.mouseClientOffset={},this.getSourceClientOffset=this.getSourceClientOffset.bind(this),this.handleWindowMoveStart=this.handleWindowMoveStart.bind(this),this.handleWindowMoveStartCapture=this.handleWindowMoveStartCapture.bind(this),this.handleWindowMoveCapture=this.handleWindowMoveCapture.bind(this),this.handleWindowMoveEndCapture=this.handleWindowMoveEndCapture.bind(this)}return i(e,[{key:"setup",value:function(){if("undefined"!=typeof window){if(this.constructor.isSetUp)throw new Error("Cannot have two DnD Mouse backend at the same time");this.constructor.isSetUp=!0,window.addEventListener("mousedown",this.handleWindowMoveStartCapture,!0),window.addEventListener("mousedown",this.handleWindowMoveStart),window.addEventListener("mousemove",this.handleWindowMoveCapture,!0),window.addEventListener("mouseup",this.handleWindowMoveEndCapture,!0)}}},{key:"getSourceClientOffset",value:function(e){return r(this.sourceNodes[e])}},{key:"teardown",value:function(){"undefined"!=typeof window&&(this.constructor.isSetUp=!1,this.mouseClientOffset={},window.removeEventListener("mousedown",this.handleWindowMoveStartCapture,!0),window.removeEventListener("mousedown",this.handleWindowMoveStart),window.removeEventListener("mousemove",this.handleWindowMoveCapture,!0),window.removeEventListener("mouseup",this.handleWindowMoveEndCapture,!0))}},{key:"connectDragSource",value:function(e,t){var o=this;this.sourceNodes[e]=t;var n=this.handleMoveStart.bind(this,e);return t.addEventListener("mousedown",n),function(){delete o.sourceNodes[e],t.removeEventListener("mousedown",n)}}},{key:"connectDragPreview",value:function(e,t,o){var n=this;return this.sourcePreviewNodesOptions[e]=o,this.sourcePreviewNodes[e]=t,function(){delete n.sourcePreviewNodes[e],delete n.sourcePreviewNodesOptions[e]}}},{key:"connectDropTarget",value:function(e,t){var o=this;return this.targetNodes[e]=t,function(){delete o.targetNodes[e]}}},{key:"handleWindowMoveStartCapture",value:function(){this.moveStartSourceIds=[]}},{key:"handleMoveStart",value:function(e){this.moveStartSourceIds.unshift(e)}},{key:"handleWindowMoveStart",value:function(e){e.preventDefault();var t=n(e);t&&(this.mouseClientOffset=t)}},{key:"handleWindowMoveCapture",value:function(e){var t=this,o=this.moveStartSourceIds,r=n(e);if(r&&(this.monitor.isDragging()||!this.mouseClientOffset.hasOwnProperty("x")||!o||this.mouseClientOffset.x===r.x&&this.mouseClientOffset.y===r.y||(this.moveStartSourceIds=null,this.actions.beginDrag(o,{clientOffset:this.mouseClientOffset,getSourceClientOffset:this.getSourceClientOffset,publishSource:!1})),this.monitor.isDragging())){var i=this.sourceNodes[this.monitor.getSourceId()];this.installSourceNodeRemovalObserver(i),this.actions.publishDragSource(),e.preventDefault();var s=Object.keys(this.targetNodes).filter(function(e){var o=t.targetNodes[e].getBoundingClientRect();return r.x>=o.left&&r.x<=o.right&&r.y>=o.top&&r.y<=o.bottom}),u=s.sort(function(e,o){return t.getParents(t.targetNodes[e]).indexOf(t.targetNodes[o])!==-1?1:-1});this.actions.hover(u,{clientOffset:r})}}},{key:"handleWindowMoveEndCapture",value:function(e){return!this.monitor.isDragging()||this.monitor.didDrop()?void(this.moveStartSourceIds=null):(e.preventDefault(),this.mouseClientOffset={},this.uninstallSourceNodeRemovalObserver(),this.actions.drop(),void this.actions.endDrag())}},{key:"installSourceNodeRemovalObserver",value:function(e){var t=this;this.uninstallSourceNodeRemovalObserver(),this.draggedSourceNode=e,this.draggedSourceNodeRemovalObserver=new window.MutationObserver(function(){e.parentElement||(t.resurrectSourceNode(),t.uninstallSourceNodeRemovalObserver())}),e&&e.parentElement&&this.draggedSourceNodeRemovalObserver.observe(e.parentElement,{childList:!0})}},{key:"resurrectSourceNode",value:function(){this.draggedSourceNode.style.display="none",this.draggedSourceNode.removeAttribute("data-reactid"),document.body.appendChild(this.draggedSourceNode)}},{key:"uninstallSourceNodeRemovalObserver",value:function(){this.draggedSourceNodeRemovalObserver&&this.draggedSourceNodeRemovalObserver.disconnect(),this.draggedSourceNodeRemovalObserver=null,this.draggedSourceNode=null}},{key:"getParents",value:function(e){for(var t=[];e;)t.unshift(e),e=e.parentNode;return t}}]),e}();t.default=u}])});